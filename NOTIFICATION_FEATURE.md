# 任务提醒通知功能

## ✅ 实现状态

**状态：已完成并通过编译测试**

所有功能已实现并成功编译，可以正常使用。

## 功能概述

为 FlowTask 添加了智能任务提醒功能，在任务即将到期时自动发送通知，帮助用户及时完成任务，避免遗漏。

---

## 🔔 核心功能

### 1. 多种通知方式

#### 系统通知（默认）
- 使用 macOS 原生通知中心
- 显示在屏幕右上角
- 支持通知历史记录
- 可以在通知中心查看

#### 菜单栏通知
- 在菜单栏显示通知横幅
- 更加醒目和直接
- 适合需要立即关注的场景

#### 双重通知
- 同时发送系统通知和菜单栏通知
- 确保不会错过重要提醒
- 适合重要任务

### 2. 灵活的提醒时机

提供 6 种提醒时机选项：

| 选项 | 说明 | 适用场景 |
|------|------|---------|
| **不提醒** | 关闭提醒功能 | 不需要提醒的任务 |
| **到期时提醒** | 任务到期时提醒（默认） | 精确时间控制 |
| **到期前提醒** | 自定义提前时间（分钟/小时/天） | 灵活配置，适合各种场景 |
| **每日定时提醒** | 每天固定时间提醒所有未完成任务 | 每日任务回顾 |
| **每周定时提醒** | 每周指定日期的固定时间提醒 | 周期性任务检查 |
| **每月定时提醒** | 每月指定日期的固定时间提醒 | 月度任务规划 |

### 3. 智能通知管理

- ✅ **自动检查**：每分钟自动检查即将到期的任务
- ✅ **避免重复**：同一任务同一时机只通知一次
- ✅ **自动清理**：任务完成后自动清理通知标记
- ✅ **后台运行**：应用在后台时也能正常提醒
- ✅ **精确时间**：±1分钟的时间容差，确保准确提醒

---

## ⚙️ 如何设置？

### 设置路径
1. 打开应用主窗口
2. 点击左侧导航栏的 "设置" 按钮
3. 选择 **"任务"** 分类
4. 在 **"任务提醒"** 区域进行配置

### 首次使用
1. 点击 **"开启通知权限"** 按钮
2. 在系统弹窗中允许通知
3. 启用 **"启用任务提醒"** 开关
4. 选择提醒时机和通知方式

### 权限管理
如果通知权限被拒绝：
1. 点击 **"去设置"** 按钮
2. 在系统设置中找到 FlowTask
3. 允许通知权限
4. 返回应用重新启用提醒

---

## 📱 通知内容

### 通知格式

#### 即将到期（提前提醒）
```
标题：任务即将到期
内容：「写周报」还有 15 分钟到期
```

#### 正在到期
```
标题：任务即将到期
内容：「写周报」即将到期
```

#### 已经逾期
```
标题：任务即将到期
内容：「写周报」已经逾期 10 分钟
```

### 通知信息
- 任务标题
- 剩余时间
- 声音提示
- 可点击查看详情

---

## 🎯 使用场景

### 场景 1：日常工作任务
- **设置**：提前 15 分钟 + 系统通知
- **效果**：在任务到期前有足够时间准备
- **适合**：会议、电话、日常待办

### 场景 2：重要项目截止
- **设置**：提前 1 天 + 双重通知
- **效果**：提前一天收到提醒，有充足时间完成
- **适合**：项目交付、报告提交、重要活动

### 场景 3：紧急任务
- **设置**：提前 5 分钟 + 菜单栏通知
- **效果**：最后时刻的醒目提醒
- **适合**：快速响应、紧急事项

### 场景 4：长期规划
- **设置**：提前 2 小时 + 系统通知
- **效果**：有足够时间调整计划和准备
- **适合**：学习计划、健身目标、习惯养成

---

## 🔧 技术实现

### 通知服务架构
```swift
NotificationService
├── 权限管理
│   ├── 请求通知权限
│   └── 检查权限状态
├── 任务检查
│   ├── 定时检查（每分钟）
│   ├── 计算剩余时间
│   └── 判断是否需要通知
├── 通知发送
│   ├── 系统通知
│   ├── 菜单栏通知
│   └── 双重通知
└── 通知管理
    ├── 避免重复通知
    └── 自动清理标记
```

### 核心特性
- **单例模式**：全局唯一的通知服务实例
- **定时器**：每分钟检查一次任务状态
- **持久化**：使用 UserDefaults 记录通知状态
- **异步处理**：使用 async/await 处理权限请求
- **观察者模式**：使用 @Published 发布权限状态

### 通知判断逻辑
```swift
// 计算剩余时间
let timeInterval = dueDate.timeIntervalSince(now)
let minutesRemaining = Int(timeInterval / 60)

// 判断是否在通知时间范围内（±1分钟容差）
let isInRange = abs(minutesRemaining - notifyMinutes) <= 1

// 检查是否已通知（避免重复）
let hasNotified = UserDefaults.standard.bool(forKey: notificationId)

// 发送通知
if isInRange && !hasNotified {
    sendNotification(for: task)
}
```

---

## 💡 使用建议

### 提醒时机选择
- **短期任务（< 1小时）**：提前 5-15 分钟
- **日常任务（1-4小时）**：提前 15-30 分钟
- **重要任务（半天）**：提前 1-2 小时
- **长期任务（> 1天）**：提前 1 天

### 通知方式选择
- **工作时间**：系统通知（不打扰工作流）
- **需要立即关注**：菜单栏通知（更醒目）
- **重要任务**：双重通知（确保不遗漏）

### 最佳实践
1. **合理设置截止时间**：为任务设置准确的截止时间
2. **选择合适的提醒时机**：根据任务重要性和紧急程度选择
3. **定期检查通知权限**：确保通知功能正常工作
4. **及时处理通知**：收到通知后及时查看和处理任务

---

## 🐛 已修复的问题

### 编译错误修复（2026-01-07）
- **问题**：`SettingsManager.swift` 中 `notificationTiming` 的默认值使用了不存在的 `.before15min` 枚举值
- **原因**：枚举定义已更新为新的提醒时机选项，但默认值未同步更新
- **修复**：将默认值改为 `.atTime`（到期时提醒）
- **位置**：`macOS/Views/Settings/SettingsManager.swift` 第 545 行
- **状态**：✅ 已修复并通过编译测试

## 🚀 未来扩展

可以考虑添加更多功能：
- 多次提醒（例如提前1天和提前1小时各提醒一次）
- 重复提醒（逾期后每隔一段时间提醒）
- 通知声音自定义
- 通知优先级设置
- 任务分类的不同提醒策略
- 勿扰模式（工作时间外不提醒）
- 通知历史记录
- 通知统计分析
- 通知操作（快速完成、延期等）

---

## ⚠️ 注意事项

### 权限要求
- 需要用户授予通知权限
- 首次使用时会弹出权限请求
- 可以在系统设置中随时修改权限

### 系统要求
- macOS 10.14 或更高版本
- 支持 UserNotifications 框架

### 已知限制
- 应用完全退出后通知功能停止
- 系统勿扰模式会影响通知显示
- 菜单栏通知在 macOS 11+ 已被弃用（但仍可用）

### 隐私说明
- 通知内容仅在本地处理
- 不会上传任何任务信息到服务器
- 通知标记存储在本地 UserDefaults
